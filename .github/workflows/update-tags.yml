name: 'Git Tag Update'
run-name: 'PR Closure #${{ github.event.pull_request.number }}'

on:
  pull_request:
    types: [closed]
    branches:
    - main
  push:
    branches:
    - release/*

permissions:
  id-token: write
  contents: write
  pull-requests: read

jobs:
  GetChangedElements:
    name: 'Get Changed Elements'
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    outputs:
      elementsToBuild: ${{ steps.elements-to-run-ci.outputs.elementsToBuild }}
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Create changed files src file
      id: create-changed-files-src-file
      shell: pwsh
      run: |
        $elements = (Get-Content changed-files-config.json | ConvertFrom-Json).elements
        New-Item changed-files-config.yaml
        foreach ($element in $elements) {
          Add-Content -Path .\changed-files-config.yaml -Value "$($element.name):"
          foreach ($path in $element.path) {
            Add-Content -Path .\changed-files-config.yaml -Value "- $path"
          }
        }
        $elementsCompressed = $elements | ConvertTo-Json -Compress
        Write-Host "pwsh = $($elements.name)"
        Write-Host "json = $elementsCompressed"
        "elements=$elementsCompressed" >> $env:GITHUB_OUTPUT
        
    - name: Evaluate Changed Files
      uses: tj-actions/changed-files@v44
      id: changed-files
      with:
        dir_names: true
        files_yaml_from_source_file: changed-files-config.yaml

    - name: Output elements to run CI for
      id: elements-to-run-ci
      shell: pwsh
      run: |
        $elements = ('${{ steps.create-changed-files-src-file.outputs.elements }}' | ConvertFrom-Json)
        Write-Host "all elements from config = $($elements.name)"
        $allOutputs = ('${{ toJson(steps.changed-files.outputs) }}' | ConvertFrom-Json)
        $elementsToBuild = @()
        foreach ($element in $elements) {
          Write-Host "$($element.name) changed:" $allOutputs."$($element.name)_any_changed"
          if ($allOutputs."$($element.name)_any_changed" -eq "true") {
            $elementsToBuild += $element
          }
        }
        if ($elementsToBuild.Count -eq 1) {
          $elementsToBuildJson = "[$($elementsToBuild | ConvertTo-Json -Compress)]"
        }
        elseif ($elementsToBuild.Count -eq 0) {
          "# :zap: NO NEW TAGS `r`n" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "## No files changed matched the paths defined in the configuration file. `r`n" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "All files changed: ${{ github.event.pull_request.changed_files }} `r`n" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
        }
        else {
          $elementsToBuildJson = $elementsToBuild | ConvertTo-Json -Compress
        }
        Write-Host "pwsh = $($elementsToBuild.name)"
        Write-Host "json = $elementsToBuildJson"
        "elementsToBuild=$elementsToBuildJson" >> $env:GITHUB_OUTPUT
        

  TestGitVersion:
    name: 'Test Git Version - ${{ matrix.element.name }}'
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true && needs.GetChangedElements.outputs.elementsToBuild
    needs: GetChangedElements
    strategy:
      fail-fast: false
      max-parallel: 5
      matrix:
        element: ${{fromJson(needs.GetChangedElements.outputs.elementsToBuild)}}
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: 'Create head branch if deleted'
      shell: pwsh
      run: |
        echo "Local branches:"
        git branch --list
        echo "Remote branches:"
        git branch --list -r
        if ($null -eq (git branch --list ${{ github.event.pull_request.head.ref }})) {
          git branch ${{ github.event.pull_request.head.ref }}
        }
        else {
          git checkout ${{ github.event.pull_request.head.ref }}
        }
    - name: 'Install GitVersion'
      uses: gittools/actions/gitversion/setup@v0
      with:
        versionSpec: '5.x'
        includePrerelease: 'false'
        preferLatestVersion: 'true'

    - name: GitVersion
      id: gitversion
      uses: gittools/actions/gitversion/execute@v0
      with:
        useConfigFile: 'true'
        additionalArguments: '-b ${{ github.event.pull_request.head.ref }} /overrideconfig tag-prefix=${{ matrix.element.name }}-v'

    - name: Output to Job Summary
      id: output-element
      shell: pwsh
      run: |
        Write-Host "New Tag: ${{ matrix.element.name }}-v${{ steps.gitversion.outputs.majorMinorPatch }}"
        Write-Host "Element: ${{ matrix.element.name }}"
        Write-Host "Element paths: ${{ toJson(matrix.element.path) }}"
        Write-Host "New version: ${{ steps.gitversion.outputs.majorMinorPatch }}"
        "# :bookmark: New Tag: ${{ matrix.element.name }}-v${{ steps.gitversion.outputs.majorMinorPatch }} `r`n" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
        "## Element: ${{ matrix.element.name }} `r`n" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
        "## New Version: ${{ steps.gitversion.outputs.majorMinorPatch }} `r`n" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
        "## Branch: ${{ github.event.pull_request.head.ref }} `r`n" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append

    - name: Push New Git Tag
      shell: 'pwsh'
      run: |
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git config user.name "github-actions[bot]"
        git tag -f ${{ matrix.element.name }}-v${{ steps.gitversion.outputs.majorMinorPatch }}
        git push origin -f ${{ matrix.element.name }}-v${{ steps.gitversion.outputs.majorMinorPatch }}